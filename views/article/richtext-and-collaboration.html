<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>富文本编辑器及协同编辑初步实践 | Kuailoy&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Get busy living, or get busy dying">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.f2cee2f9.css" as="style"><link rel="preload" href="/assets/js/app.5a2ae76a.js" as="script"><link rel="preload" href="/assets/js/4.ff477fe3.js" as="script"><link rel="preload" href="/assets/js/1.2851c76d.js" as="script"><link rel="preload" href="/assets/js/8.cea61380.js" as="script"><link rel="prefetch" href="/assets/js/10.6c89e52a.js"><link rel="prefetch" href="/assets/js/11.c27d3bb1.js"><link rel="prefetch" href="/assets/js/12.c266121c.js"><link rel="prefetch" href="/assets/js/13.b0941e7b.js"><link rel="prefetch" href="/assets/js/14.2960fde2.js"><link rel="prefetch" href="/assets/js/15.8178cd4c.js"><link rel="prefetch" href="/assets/js/16.51e0a512.js"><link rel="prefetch" href="/assets/js/17.3f3a81d8.js"><link rel="prefetch" href="/assets/js/18.1b11a5a2.js"><link rel="prefetch" href="/assets/js/19.4ddc72f1.js"><link rel="prefetch" href="/assets/js/20.b83e4571.js"><link rel="prefetch" href="/assets/js/21.f280ebaa.js"><link rel="prefetch" href="/assets/js/22.5cb0b36c.js"><link rel="prefetch" href="/assets/js/23.a6915afc.js"><link rel="prefetch" href="/assets/js/24.e6b9913e.js"><link rel="prefetch" href="/assets/js/25.8723d116.js"><link rel="prefetch" href="/assets/js/26.d137e78d.js"><link rel="prefetch" href="/assets/js/27.bb7d0023.js"><link rel="prefetch" href="/assets/js/28.f53f1844.js"><link rel="prefetch" href="/assets/js/29.4a2c0950.js"><link rel="prefetch" href="/assets/js/30.de397ca2.js"><link rel="prefetch" href="/assets/js/31.683f9a42.js"><link rel="prefetch" href="/assets/js/32.3505806b.js"><link rel="prefetch" href="/assets/js/33.cbcf6376.js"><link rel="prefetch" href="/assets/js/34.cbf8b22a.js"><link rel="prefetch" href="/assets/js/35.351779c5.js"><link rel="prefetch" href="/assets/js/36.6b614ac8.js"><link rel="prefetch" href="/assets/js/37.ec6ae891.js"><link rel="prefetch" href="/assets/js/38.9fb18659.js"><link rel="prefetch" href="/assets/js/39.aa3eb5a1.js"><link rel="prefetch" href="/assets/js/5.370fa96e.js"><link rel="prefetch" href="/assets/js/6.80ca6d97.js"><link rel="prefetch" href="/assets/js/7.240fcb43.js"><link rel="prefetch" href="/assets/js/9.2107b831.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.5f142d7f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f2cee2f9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Kuailoy's Blog</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>Get busy living, or get busy dying</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>kuailoy</span>
            
          <span data-v-25ba6db2>2019 - </span>
          2024
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.jpg" alt="Kuailoy's Blog" class="logo"> <span class="site-name">Kuailoy's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/algorithm/" class="nav-link"><i class="undefined"></i>
  algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/git/" class="nav-link"><i class="undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/categories/docker/" class="nav-link"><i class="undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/macOS/" class="nav-link"><i class="undefined"></i>
  macOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/fontEnd/" class="nav-link"><i class="undefined"></i>
  fontEnd
</a></li><li class="dropdown-item"><!----> <a href="/categories/踩坑/" class="nav-link"><i class="undefined"></i>
  踩坑
</a></li><li class="dropdown-item"><!----> <a href="/categories/server/" class="nav-link"><i class="undefined"></i>
  server
</a></li><li class="dropdown-item"><!----> <a href="/categories/frontEnd/" class="nav-link"><i class="undefined"></i>
  frontEnd
</a></li><li class="dropdown-item"><!----> <a href="/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/kuailoy" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    kuailoy
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>28</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>18</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/algorithm/" class="nav-link"><i class="undefined"></i>
  algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/git/" class="nav-link"><i class="undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/categories/docker/" class="nav-link"><i class="undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/macOS/" class="nav-link"><i class="undefined"></i>
  macOS
</a></li><li class="dropdown-item"><!----> <a href="/categories/fontEnd/" class="nav-link"><i class="undefined"></i>
  fontEnd
</a></li><li class="dropdown-item"><!----> <a href="/categories/踩坑/" class="nav-link"><i class="undefined"></i>
  踩坑
</a></li><li class="dropdown-item"><!----> <a href="/categories/server/" class="nav-link"><i class="undefined"></i>
  server
</a></li><li class="dropdown-item"><!----> <a href="/categories/frontEnd/" class="nav-link"><i class="undefined"></i>
  frontEnd
</a></li><li class="dropdown-item"><!----> <a href="/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/kuailoy" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>富文本编辑器及协同编辑初步实践</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>kuailoy</span>
            
          <span data-v-25ba6db2>2019 - </span>
          2024
        </a></span></div></div> <div data-v-130b300a><main class="page"><section><div class="page-title"><h1 class="title">富文本编辑器及协同编辑初步实践</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>kuailoy</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>2/22/2022</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>slate</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="概览"><a href="#概览" class="header-anchor">#</a> 概览</h2> <p>本文主要内容包括</p> <ul><li>富文本编辑器简介</li> <li>Slate.js介绍和Plate组件库介绍</li> <li>协同编辑的实现方案</li></ul> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>富文本编辑器，指的是用户能够在浏览器中编排富文本（具有风格及排版的文本，如可以设定字体样式，进行图文混排等）。
个人理解：富文本编辑器一方面是「所见即所得」的Markdown编辑器，是对Markdown的补充和扩展；同时，用户也可以获得类似word的编辑体验</p> <h3 id="浏览器的contenteditable"><a href="#浏览器的contenteditable" class="header-anchor">#</a> 浏览器的contentEditable</h3> <p>浏览器天然具备了「展示」富文本的能力，开发者可以通过编排 HTML 和 CSS，实现对字号，字色等样式控制。但对于用户输入，浏览器所提供的 <code>&lt;textarea /&gt;</code> 和 <code>&lt;input /&gt;</code> 都只允许用户输入「纯文本」，能力十分单薄。
​</p> <p>因此，如果我们能够直接编辑 HTML 内容，也就具备了「编辑」富文本的能力。例如当我们选中文本 xxx 并按下加粗的快捷键后，若能生成 <code>&lt;b&gt;xxx&lt;/b&gt;</code> 或者 <code>&lt;strong&gt;xxx&lt;/strong&gt;</code> 这样的 HTML，就能看到被加粗的文本。
浏览器为 DOM 节点提供的 contentEditble 属性即能为节点赋予「编辑其 HTML 内容」的能力。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 例子 1 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">contenteditable</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 例子 2 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">contenteditable</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="为什么需要第三方库"><a href="#为什么需要第三方库" class="header-anchor">#</a> 为什么需要第三方库</h3> <h4 id="contenteditable存在的问题"><a href="#contenteditable存在的问题" class="header-anchor">#</a> <code>contentEditable</code>存在的问题</h4> <ul><li>同样的视觉内容，不同浏览器中，对应的DOM结构有差异</li> <li>光标的选区：用户看到的选区，可能被映射为不同的 DOM 选区</li></ul> <h4 id="主流编辑器的架构"><a href="#主流编辑器的架构" class="header-anchor">#</a> 主流编辑器的架构</h4> <ul><li>模型于视图分离：编辑器自定义视图无关的数据结构</li> <li>自定义指令： 自定义编辑器的指令集，一方面能扩充编辑器能力，但更重要的一方面，是避免直接调用 document.execCommand 在不同浏览器形成不一致的结果</li></ul> <p><img src="/assets/img/diagram-1.45898aaa.jpg" alt="Architecture of mainstream editors"></p> <p>目前主流的编辑器大多采取上述的架构，例如 CKEditor 5、ProseMirror、Draft.js、Slate.js 等</p> <h2 id="slate-js"><a href="#slate-js" class="header-anchor">#</a> slate.js</h2> <h3 id="为什么选择slate-js"><a href="#为什么选择slate-js" class="header-anchor">#</a> 为什么选择Slate.js</h3> <ul><li>轻量化、插件机制、易于扩展和自定义开发</li> <li>核心库与视图层分离，通过slate-react可以很方便的使用react开发</li> <li>协同编辑：模型设计天然支持协同编辑</li></ul> <p>官方文档 <a href="https://docs.slatejs.org/" target="_blank" rel="noopener noreferrer">https://docs.slatejs.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
官方Demo <a href="https://www.slatejs.org/examples/richtext" target="_blank" rel="noopener noreferrer">https://www.slatejs.org/examples/richtext<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
​</p> <p>例子: code block的简单实现</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> editor <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">withReact</span><span class="token punctuation">(</span><span class="token function">createEditor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'paragraph'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">'A line of text in a paragraph.'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> renderElement <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'code'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">CodeElement</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultElement</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slate</span></span> <span class="token attr-name">editor</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>editor<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      &lt;Editable
        renderElement=</span><span class="token punctuation">{</span>renderElement<span class="token punctuation">}</span><span class="token plain-text">
        onKeyDown=</span><span class="token punctuation">{</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">'`'</span> <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>ctrlKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// Determine whether any of the currently selected blocks are code blocks.</span>
            <span class="token keyword">const</span> <span class="token punctuation">[</span>match<span class="token punctuation">]</span> <span class="token operator">=</span> Editor<span class="token punctuation">.</span><span class="token function">nodes</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> <span class="token punctuation">{</span>
              <span class="token function-variable function">match</span><span class="token operator">:</span> <span class="token parameter">n</span> <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment">// Toggle the block type depending on whether there's already a match.</span>
            Transforms<span class="token punctuation">.</span><span class="token function">setNodes</span><span class="token punctuation">(</span>
              editor<span class="token punctuation">,</span>
              <span class="token punctuation">{</span> type<span class="token operator">:</span> match <span class="token operator">?</span> <span class="token string">'paragraph'</span> <span class="token operator">:</span> <span class="token string">'code'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span> <span class="token function-variable function">match</span><span class="token operator">:</span> <span class="token parameter">n</span> <span class="token operator">=&gt;</span> Editor<span class="token punctuation">.</span><span class="token function">isBlock</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain-text">
      /&gt;
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Slate</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="slate中的数据模型"><a href="#slate中的数据模型" class="header-anchor">#</a> Slate中的数据模型</h3> <p>Slate.js 在数据模型的设计宗旨是 「Mirror the DOM」，即尽可能按照现行的 DOM 标准去抽象自己的数据模型。</p> <p><img src="/assets/img/diagram-2.e3f15437.jpg" alt="Model of Slate"></p> <h3 id="mark-leaf"><a href="#mark-leaf" class="header-anchor">#</a> Mark &amp; Leaf</h3> <p>Slate.js 根据 mark 类型的不同，将 Text Node 拆分为了若干 Leaf。每个 Leaf 对象含有这些属性：</p> <ul><li>text: string：leaf 的文本内容</li> <li>mark: Mark: leaf 被标记上的 mark</li></ul> <h3 id="commands"><a href="#commands" class="header-anchor">#</a> Commands</h3> <p>Slate提供了一个编辑器实例（editor）作为controller，可以通过对它绑定各种指令来实现操作,
内置的指令例如：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>Editor<span class="token punctuation">.</span><span class="token function">insertText</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> <span class="token string">'A new string of text to be inserted.'</span><span class="token punctuation">)</span>
Editor<span class="token punctuation">.</span><span class="token function">deleteBackward</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> <span class="token punctuation">{</span> unit<span class="token operator">:</span> <span class="token string">'word'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
Editor<span class="token punctuation">.</span><span class="token function">insertBreak</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span>
</code></pre></div><p>开发者可以通过自定义指令对editor进行扩展，例如增加一个<code>editor.toggleBold</code> 指令，来切换文本是否加粗</p> <h3 id="transforms"><a href="#transforms" class="header-anchor">#</a> Transforms</h3> <p>Transform 是slate提供的更具体的一些操作，你可以通过组合Transform来自定一一个指令，以上面的toggleBold为例</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// Set a &quot;bold&quot; format on all of the text nodes in a range.</span>
Transforms<span class="token punctuation">.</span><span class="token function">setNodes</span><span class="token punctuation">(</span>
  editor<span class="token punctuation">,</span>
  <span class="token punctuation">{</span> bold<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    at<span class="token operator">:</span> range<span class="token punctuation">,</span>
    <span class="token function-variable function">match</span><span class="token operator">:</span> <span class="token parameter">node</span> <span class="token operator">=&gt;</span> Text<span class="token punctuation">.</span><span class="token function">isText</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span>
    split<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="operations"><a href="#operations" class="header-anchor">#</a> Operations</h3> <p>相对于Transform，operation代表更细粒度和更为底层的操作，每次调用Command 或 Transform，并不会立即更新文档模型，而是会触发一个或多个Operation</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">editor</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'insert_text'</span><span class="token punctuation">,</span>
  path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  offset<span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
  text<span class="token operator">:</span> <span class="token string">'A new string of text to be inserted.'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">editor</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'remove_node'</span><span class="token punctuation">,</span>
  path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  node<span class="token operator">:</span> <span class="token punctuation">{</span>
    text<span class="token operator">:</span> <span class="token string">'A line of text!'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">editor</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'set_selection'</span><span class="token punctuation">,</span>
  properties<span class="token operator">:</span> <span class="token punctuation">{</span>
    anchor<span class="token operator">:</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  newProperties<span class="token operator">:</span> <span class="token punctuation">{</span>
    anchor<span class="token operator">:</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">15</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>问题：Slate.js 为什么不直接在调用指令的时候就修改文档内容呢？而是还需要 Operation 这个中间产物呢？</p></blockquote> <p>考虑在多人协同场景下，用户 A 和用户 B 同时编辑一篇文档，这篇文档的内容是 12345：</p> <ul><li>A 调用 insertText 指令在 4 后面插入了文本 a，生成了新的文档 1234a5</li> <li>B 调用 removeText 指令删除了 5，生成了新的文档 1234</li> <li>B 生成的新文档 1234 被广播给了 A</li></ul> <p>当 A、B 执行完各自的操作后，对于多人协作文档来说，期望每个用户「彼时彼刻都看到同样的内容」。当 A 拿到了 B 的文档 1234 后，它应该作何反应，才能计算出一篇 A、B 看到一样结果的内容？显然，A 首先需要知道 B 做了什么操作，为此，它就会计算 12345 与 1234 的 diff，推演出 B 是做了删除了 5 的动作。</p> <p><img src="/assets/img/image-1.0e5c70e7.png" alt="image-1.png"></p> <p>假设以文档模型作为最小抽象，绕不开：</p> <ul><li>协同时「传输对象是整个文档」（全量传输）</li> <li>协同时总要「计算本地文档和远端文档的 diff」（全量计算）</li></ul> <p>既然如此，与其告诉对方自己生成了怎样的内容，不如再细致一点，告诉对方自己执行了怎样的操作：</p> <ul><li>A 告诉 B：自己在文本 12345 的第 4 个位置插入了文本 a</li> <li>B 告诉 A：自己删除了文本 12345 的第 4 个位置的文本</li></ul> <p>这样节约带宽的同时，也省却了对文档的 diff 的计算（增量传输）</p> <p>Operation类型
<img src="/assets/img/image-2.febe05a0.png" alt="image-2.png"></p> <h3 id="slate的插件体系"><a href="#slate的插件体系" class="header-anchor">#</a> Slate的插件体系</h3> <p>新版的Slate.js 插件体系，使用组合（Composition）模型实现，例如：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createEditor <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'slate'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">withImages</span> <span class="token operator">=</span> <span class="token parameter">editor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> isVoid <span class="token punctuation">}</span> <span class="token operator">=</span> editor<span class="token punctuation">;</span>

  editor<span class="token punctuation">.</span><span class="token function-variable function">isVoid</span> <span class="token operator">=</span> <span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'image'</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token function">isVoid</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> editor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> editor <span class="token operator">=</span> <span class="token function">withImages</span><span class="token punctuation">(</span><span class="token function">createEditor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这种风格虽然带来了更加自由的组织方式，但却「不利于编辑器能力的插拔」, 当我们想扩展或者移除某个能力时，只能修改对应的 Event Handler。对于大型编辑器来说，这就会成为能力扩展的掣肘。</p> <h2 id="plate插件库"><a href="#plate插件库" class="header-anchor">#</a> Plate插件库</h2> <p>Slate官方推荐的基于Slate实现的插件库（slate-plugin）
Plate以插件形式实现了大部分富文本的功能，它的重要意义在于提供了一个良好的slate插件的组织方式
其内部则通过组合的方式，串联这些插件的Hook</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// plate插件组织形式</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">// elements</span>
  <span class="token function">createParagraphPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// paragraph element</span>
  <span class="token function">createBlockquotePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// blockquote element</span>
  <span class="token function">createCodeBlockPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// code block element</span>
  <span class="token function">createHeadingPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// heading elements</span>

  <span class="token comment">// marks</span>
  <span class="token function">createBoldPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// bold mark</span>
  <span class="token function">createItalicPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// italic mark</span>
  <span class="token function">createUnderlinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// underline mark</span>
  <span class="token function">createStrikethroughPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// strikethrough mark</span>
  <span class="token function">createCodePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// code mark</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Plate</span></span>
      <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">editableProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>editableProps<span class="token punctuation">}</span></span>
      <span class="token attr-name">initialValue</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token constant">VALUES</span><span class="token punctuation">.</span>basicNodes<span class="token punctuation">}</span></span>
      <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onChangeDebug<span class="token punctuation">}</span></span>
      <span class="token attr-name">plugins</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>plugins<span class="token punctuation">}</span></span>
    <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span>debugValue<span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="协同编辑"><a href="#协同编辑" class="header-anchor">#</a> 协同编辑</h2> <h3 id="协同编辑面临的主要问题"><a href="#协同编辑面临的主要问题" class="header-anchor">#</a> 协同编辑面临的主要问题</h3> <ol><li>脏路径问题：插入时，由于其他用户操作，导致插入位置变化引发的错误</li></ol> <p><img src="/assets/img/image-3.6be2c5e0.png" alt="image-3.png"> <img src="/assets/img/image-4.9d26462a.png" alt="image-4.png">
注：图片来源（<a href="https://zhuanlan.zhihu.com/p/425265438?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=719793876033867776" target="_blank" rel="noopener noreferrer">多人协同编辑技术的演进 2021-10-24<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <ol start="2"><li>并发冲突问题：对同一节点的不同操作，比如A用户align = 'left'，B用户align =  'right'</li> <li>undos/redos 问题:  <strong>撤回应当只撤回自己的操作，协同者的操作应当被忽略</strong>。</li> <li>工程实现问题：数据同步、光标同步、网络问题、文档版本历史、离线编辑......</li></ol> <h3 id="数据一致性算法"><a href="#数据一致性算法" class="header-anchor">#</a> 数据一致性算法</h3> <h4 id="ot算法"><a href="#ot算法" class="header-anchor">#</a> OT算法</h4> <p>OT 全称是 Operational Transformation，它的核心思想是<strong>操作转换</strong>，通过转换数据修改操作解决协同编辑中的各种问题。
广泛应用于文档类产品，例如Google docs、Office 365、石墨、钉钉、腾讯文档
​</p> <p>原理图</p> <p><img src="/assets/img/diagram-3.c02f4c75.jpg" alt="diagram-3.png"></p> <ul><li>a 标识左边用户的 operation</li> <li>b 表示右边用户的 operation</li> <li>二者交叉的点表示文档基于相同的初始状态</li></ul> <p><strong>操作转换：</strong>
为了客户端和服务端的文档达到一致的状态，我们需要对 a 和 b 进行操作转换 transfrom(a, b) =&gt; (a', b') 得到两个衍生的操作作 a' 和 b'
左边用户的 a 操作的衍生操作 a' 在右边用户端应用，b' 在左边用户端应用，最终文档内容达到一致。
<strong>解决冲突：</strong>
基于 OT 解决「并发冲突」同样是使用操作转换逻辑，<strong>协调冲突的属性修改</strong>，得到最终的结果</p> <blockquote><p>这里说明的只是最基础的 OT 模型，每个客户端只有一个操作的情况（1 : 1），还有每个客户端对应多个操作的情况（M : N），还有 OT 控制算法等等
真实的情况可能要复杂很多，需要对每一种操作类型做交叉操作转换</p></blockquote> <h4 id="crdt算法"><a href="#crdt算法" class="header-anchor">#</a> CRDT算法</h4> <p>CRDT (Conflict-free Replicated Data Type)即“无冲突复制数据类型”，它主要被应用在分布式系统中，保证分布式应用的数据一致性
<strong>解决脏路径问题</strong>
CRDT采用双向链表的数据结构，每个节点都有一个唯一标识</p> <ul><li>在 Index=2 的位置插入 Access  -&gt;  在 标识111 之后插入 Access</li> <li>在 Index=4 的位置插入 Testhub -&gt; 在 333 之后插入 Testhub</li></ul> <p><strong>解决冲突：</strong>
每一个操作基于的状态都是<strong>最新状态</strong>，执行的操作是有确定先后顺序的
​</p> <h4 id="crdt与ot对比"><a href="#crdt与ot对比" class="header-anchor">#</a> CRDT与OT对比</h4> <ul><li>相对于 OT ，CRDT是一种全新的解决方案</li> <li>OT可以理解为是通过算法控制保证数据一致性，CRDT 通过数据结构设计保证数据一致性，</li> <li>CRDT它在复杂的网络环境中的处理是更稳健的</li> <li>CRDT 的代价就是要保存更多的元数据，这会带来一定内存消耗，但是这是可优化的，事实证明这个代价在协同编辑场景是完全可忽略不计的。</li></ul> <h3 id="slate的协同编辑方案"><a href="#slate的协同编辑方案" class="header-anchor">#</a> Slate的协同编辑方案</h3> <h3 id="yjs"><a href="#yjs" class="header-anchor">#</a> Yjs</h3> <p>​<a href="https://github.com/yjs/yjs" target="_blank" rel="noopener noreferrer">https://github.com/yjs/yjs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>CRDT的主流实现，对CRDT算法做了很多性能优化</p> <p>Yjs 对使用者提供了如 YText、YArray 和 YMap 等常用数据类型，它们都是YModel 的实例
它的强大之处在于这些数据在更新时，潜在的状态冲突已经被Yjs自动解决了</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 可以用 2 份独立的 YDoc 实例来模拟 2 个客户端</span>
<span class="token keyword">const</span> doc1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> doc2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> yText1 <span class="token operator">=</span> doc1<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> yText2 <span class="token operator">=</span> doc2<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 在某份 YDoc 更新时，应用二进制的 update 数据到另一份 YDoc 上</span>
doc1<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>doc2<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">)</span>
doc2<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>doc1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 制造两次存在潜在冲突的更新</span>
yText1<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Edwards'</span><span class="token punctuation">)</span>
yText2<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Wilson'</span><span class="token punctuation">)</span>

<span class="token comment">// CRDT 算法可保证两份客户端中的状态始终一致</span>
yText1<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// WilsonEdwards</span>
yText2<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// WilsonEdwards</span>
</code></pre></div><h3 id="slate-yjs"><a href="#slate-yjs" class="header-anchor">#</a> slate-yjs</h3> <p>基于yjs与slate进行整合，在Yjs数据的基础上提供了数据同步和光标位置同步的方案
同时提供一个node服务来支持websocket同步数据​</p> <h3 id="富文本在项目中的实际使用"><a href="#富文本在项目中的实际使用" class="header-anchor">#</a> 富文本在项目中的实际使用</h3> <p>Slate与Plate整合</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> pluginsMemo <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">createPlugins</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span>
        <span class="token function">createParagraphPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createBlockquotePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createTodoListPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
        <span class="token function">createCaretPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> component<span class="token operator">:</span> Leaf <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> components <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> plugins<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注册光标插件</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createPluginFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@udecode/plate-core'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">CARET</span> <span class="token operator">=</span> <span class="token string">'caret'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> createCaretPlugin <span class="token operator">=</span> <span class="token function">createPluginFactory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  key<span class="token operator">:</span> <span class="token constant">CARET</span><span class="token punctuation">,</span>
  isLeaf<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>光标组件</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">const</span> Leaf<span class="token operator">:</span> React<span class="token punctuation">.</span><span class="token constant">FC</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RenderLeafProps</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> = React.memo(({ attributes, children, leaf }) =&gt; </span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> isCaret <span class="token punctuation">}</span> <span class="token operator">=</span> leaf <span class="token keyword">as</span> any<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>
      <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">attributes</span><span class="token punctuation">}</span></span>
      <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
          position<span class="token operator">:</span> <span class="token string">'relative'</span><span class="token punctuation">,</span>
          backgroundColor<span class="token operator">:</span> data<span class="token operator">?.</span>alphaColor<span class="token punctuation">,</span>
        <span class="token punctuation">}</span> <span class="token keyword">as</span> any
      <span class="token punctuation">}</span></span>
    <span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>isCaret <span class="token operator">?</span> <span class="token operator">&lt;</span>Caret <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">(</span>leaf <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">);
</span></code></pre></div><p>在应用Plate插件的基础上，注册需要的Caret插件(光标)，同时应用Yjs插件
<img src="/assets/img/image-5.78e360aa.png" alt="image-5"></p> <p><img src="/assets/img/image-6.fced16d3.png" alt="image-6"> <img src="/assets/img/image-7.620d4c80.png" alt="image-7">
效果</p> <p>应用结构
注：node服务的作用是接收和缓存yjs数据，回调api时转为JSON存储</p> <p><img src="/assets/img/image-8.bd02ddbf.jpg" alt="image-8"></p> <p>参考文章：</p> <p><a href="https://zhuanlan.zhihu.com/p/425265438?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=719793876033867776" target="_blank" rel="noopener noreferrer">多人协同编辑技术的演进 2021-10-24<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/7049148428609126414" target="_blank" rel="noopener noreferrer">探秘前端 CRDT 实时协作库 Yjs 工程实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://zhuanlan.zhihu.com/p/298101935" target="_blank" rel="noopener noreferrer">深入Slate.js系列——钉钉文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/9/2024, 2:47:26 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#概览" class="sidebar-link reco-side-概览" data-v-cb1513f6>概览</a></li><li class="level-2" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#简介" class="sidebar-link reco-side-简介" data-v-cb1513f6>简介</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#浏览器的contenteditable" class="sidebar-link reco-side-浏览器的contenteditable" data-v-cb1513f6>浏览器的contentEditable</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#为什么需要第三方库" class="sidebar-link reco-side-为什么需要第三方库" data-v-cb1513f6>为什么需要第三方库</a></li><li class="level-2" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#slate-js" class="sidebar-link reco-side-slate-js" data-v-cb1513f6>slate.js</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#为什么选择slate-js" class="sidebar-link reco-side-为什么选择slate-js" data-v-cb1513f6>为什么选择Slate.js</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#slate中的数据模型" class="sidebar-link reco-side-slate中的数据模型" data-v-cb1513f6>Slate中的数据模型</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#mark-leaf" class="sidebar-link reco-side-mark-leaf" data-v-cb1513f6>Mark &amp; Leaf</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#commands" class="sidebar-link reco-side-commands" data-v-cb1513f6>Commands</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#transforms" class="sidebar-link reco-side-transforms" data-v-cb1513f6>Transforms</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#operations" class="sidebar-link reco-side-operations" data-v-cb1513f6>Operations</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#slate的插件体系" class="sidebar-link reco-side-slate的插件体系" data-v-cb1513f6>Slate的插件体系</a></li><li class="level-2" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#plate插件库" class="sidebar-link reco-side-plate插件库" data-v-cb1513f6>Plate插件库</a></li><li class="level-2" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#协同编辑" class="sidebar-link reco-side-协同编辑" data-v-cb1513f6>协同编辑</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#协同编辑面临的主要问题" class="sidebar-link reco-side-协同编辑面临的主要问题" data-v-cb1513f6>协同编辑面临的主要问题</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#数据一致性算法" class="sidebar-link reco-side-数据一致性算法" data-v-cb1513f6>数据一致性算法</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#slate的协同编辑方案" class="sidebar-link reco-side-slate的协同编辑方案" data-v-cb1513f6>Slate的协同编辑方案</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#yjs" class="sidebar-link reco-side-yjs" data-v-cb1513f6>Yjs</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#slate-yjs" class="sidebar-link reco-side-slate-yjs" data-v-cb1513f6>slate-yjs</a></li><li class="level-3" data-v-cb1513f6><a href="/views/article/richtext-and-collaboration.html#富文本在项目中的实际使用" class="sidebar-link reco-side-富文本在项目中的实际使用" data-v-cb1513f6>富文本在项目中的实际使用</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.5a2ae76a.js" defer></script><script src="/assets/js/4.ff477fe3.js" defer></script><script src="/assets/js/1.2851c76d.js" defer></script><script src="/assets/js/8.cea61380.js" defer></script>
  </body>
</html>
